<!DOCTYPE html>
<html>
<head>
  <title>Thread Rating</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #loading {
      font-weight: bold;
      color: #555;
    }
    .rating-buttons button {
      font-size: 16px;
      margin: 3px;
      padding: 5px 10px;
    }
    #average {
      font-weight: bold;
      margin-top: 20px;
    }
    #error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Rate this Post (0â€“10)</h2>
  <div id="loading">Loading ratings...</div>
  <p id="average"></p>

  <div class="rating-buttons" id="rating-buttons"></div>
  <button id="submitBtn" disabled>Post Rating</button>
  <p id="your-rating">Your rating: Not set</p>
  <p id="error"></p>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBii6O_yh0kisKfD0D_zNRrv86pYUPD-wQ",
      authDomain: "review-62187.firebaseapp.com",
      projectId: "review-62187",
      storageBucket: "review-62187.appspot.com",
      messagingSenderId: "891310783225",
      appId: "1:891310783225:web:c96f3e2168d48f55af0028"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const threadId = urlParams.get('thread') || 'default-thread';

    const loadingP = document.getElementById('loading');
    const averageP = document.getElementById('average');
    const ratingButtonsDiv = document.getElementById('rating-buttons');
    const submitBtn = document.getElementById('submitBtn');
    const yourRatingP = document.getElementById('your-rating');
    const errorP = document.getElementById('error');

    let currentUserId = null;
    let selectedRating = null;

    // Create buttons 0-10
    for (let i = 0; i <= 10; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.addEventListener('click', () => {
        selectedRating = i;
        submitBtn.disabled = false;
        errorP.textContent = '';
      });
      ratingButtonsDiv.appendChild(btn);
    }

    submitBtn.addEventListener('click', submitRating);

    auth.signInAnonymously().then(() => {
      currentUserId = auth.currentUser.uid;
      loadRatings();
      loadYourRating();
    }).catch(error => {
      errorP.textContent = 'Auth error: ' + error.message;
      loadingP.textContent = '';
    });

    function loadRatings() {
      loadingP.textContent = 'Loading ratings...';
      averageP.textContent = '';
      db.collection('posts').doc(threadId)
        .collection('ratings')
        .get()
        .then(snapshot => {
          let total = 0;
          let count = 0;
          snapshot.forEach(doc => {
            total += doc.data().rating;
            count++;
          });
          if (count === 0) {
            averageP.textContent = 'No ratings yet.';
          } else {
            const avg = (total / count).toFixed(2);
            averageP.textContent = `Overall rating: ${avg}/10 from ${count} user${count===1?'':'s'}`;
          }
          loadingP.textContent = '';
        })
        .catch(error => {
          errorP.textContent = 'Error loading ratings: ' + error.message;
          loadingP.textContent = '';
        });
    }

    function loadYourRating() {
      db.collection('posts').doc(threadId)
        .collection('ratings').doc(currentUserId)
        .get()
        .then(doc => {
          if (doc.exists) {
            const r = doc.data().rating;
            yourRatingP.textContent = `Your rating: ${r}/10`;
          }
        })
        .catch(error => {
          errorP.textContent = 'Error loading your rating: ' + error.message;
        });
    }

    function submitRating() {
      if (selectedRating === null) {
        errorP.textContent = 'Please select a rating.';
        return;
      }
      errorP.textContent = '';
      submitBtn.disabled = true;
      loadingP.textContent = 'Submitting...';

      db.collection('posts').doc(threadId)
        .collection('ratings').doc(currentUserId)
        .set({
          rating: selectedRating,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          yourRatingP.textContent = `Your rating: ${selectedRating}/10`;
          loadingP.textContent = '';
          loadRatings();
        })
        .catch(error => {
          errorP.textContent = 'Error submitting rating: ' + error.message;
          loadingP.textContent = '';
          submitBtn.disabled = false;
        });
    }
  </script>
</body>
</html>
